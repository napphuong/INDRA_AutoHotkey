^1::
Gosub, PrepareData
Gosub, DownloadOnePage
return

;^0::
InputData:
Gosub, PrepareData
;load INDRA	
Click 148, 211
;Wait for IE window become blank.
Loop
{
PixelSearch, Px, Py, 398, 125, 419, 137, 0xFFFFFF, 3, RGB
if !ErrorLevel
    break
sleep, 50
}

;Wait for IE window loaded.
Loop
{
PixelSearch, Px, Py, 361, 495, 395, 507, 0x666666, 3, RGB
if !ErrorLevel
    break
sleep, 50
}
;input search value and option
Loop, 3
{
    Send, {Tab}
}	
Send, ^v
Send, `%
Loop, 10
{
    Send, {Shift down}{Tab}{Shift up}
}
Send, {Right}
Send, {Right}
Loop, 2
{
    Send, {Shift down}{Tab}{Shift up}
}
Send, {Left}
Send, {Shift down}{Tab}{Shift up}
Send, {Right}
Send, {Shift down}{Tab}{Shift up}
return

PrepareData:
;copy folder name
;Clipboard =
;DownloadItem =
;Send, {F2}
;Send ^c
;ClipWait 1
;DownloadItem:= "D:\Downloads\" . Clipboard

;switch to INDRA
WinActivate PMS INDRA - Internet Explorer
WinWaitActive, PMS INDRA - Internet Explorer
sleep 500
Loop
{
PixelSearch, Px, Py, 943, 64, 995, 89, 0xFF0000, 3, RGB
if !ErrorLevel
    break
sleep, 50
}
return

;^1::
DownloadTextFile:
Gosub, InputData
;download text file
WinActivate PMS INDRA - Internet Explorer
Click 358, 199
Gosub, Download2
Gosub, FinishDownload2
sleep 100
return

;^2::
Gosub, PrepareData
DownloadOnePage:
    ; check if IE is loaded.
    Loop
    {
        PixelSearch, Px, Py, 811, 280, 870, 299, 0x666666 , 5, RGB
        if !ErrorLevel
            break
        sleep, 50
    }
    sleep, 300
    ;get number of record
    WinActivate PMS INDRA - Internet Explorer
    WinWaitActive, PMS INDRA - Internet Explorer
    Clipboard =
    MyString =
    Send ^a
    sleep 100
    Send ^c
    ClipWait 1
    sleep 500
    MyString := Clipboard

    pos0:= InStr(MyString, "e-File List")
    pos1:= InStr(MyString,"to")
    pos2:= InStr(MyString,"of")
    pos3:= InStr(MyString,"Records")

    fromStart:= pos0 + 29
    fromLength:= pos1 - pos0 - 30
    fromValue:= SubStr(MyString, fromStart, fromLength)

    toStart:= pos1 + 4
    toLength:= pos2 - pos1 - 5
    toValue:= SubStr(MyString, toStart, toLength)

    pageRecordValue:= toValue - fromValue + 1

    totalRecordsStart:= pos2 + 2
    totalRecordsLength:= pos3 - pos2 -3
    totalRecordsNumber:= SubStr(MyString, totalRecordsStart, totalRecordsLength)

    ;download all if pageRecordValue <31
    if (pageRecordValue <31) {
        Gosub, DownThemAll
    }
    else {
        ;download each 25 records if pageRecordValue >=31
	skipItems:= 0
	unselectItems:= 0
	selectItems:= 25
        Gosub, DownloadItems
	unselectItems:= 25
        Loop {
	    pageRecordValue:= pageRecordValue - 25
	    if (pageRecordValue <= 0)
	    {
		break
	    }
	    else if (pageRecordValue < 25)
	    {
		selectItems:= pageRecordValue
	    }
	    Gosub, DownloadItems
	    skipItems:= skipItems + 25
	}
    }
return

;^3::
Gosub, PrepareData
Gosub, DownloadFromHereToTheEnd
return

;^4::
SearchAndDownloadAll:
Gosub, DownloadTextFile
;search file
WinActivate PMS INDRA - Internet Explorer
WinWaitActive, PMS INDRA - Internet Explorer
Click 271, 201

DownloadFromHereToTheEnd:
Loop
{
Gosub, DownloadOnePage
; exit loop and minimize
    if (toValue = totalRecordsNumber){
        Gosub, FinishDownload0
        return
    }
    sleep, 50
    WinActivate PMS INDRA - Internet Explorer
    WinWaitActive, PMS INDRA - Internet Explorer
    Click 301, 219
    ;Wait for IE window become blank.
    Loop
    {
    PixelSearch, Px, Py, 398, 125, 419, 137, 0xFFFFFF, 3, RGB
    if !ErrorLevel
        break
    sleep, 50
    }
}
return

;^5::
InputBox, UserInput, Items, Please enter item number
Loop, %UserInput%
{
Gosub, MakingFolder
Gosub, SearchAndDownloadAll
}
return

;^6::
InputBox, UserInput, Items, Please enter item number
Loop, %UserInput%
{
Gosub, MakingFolder
Gosub, DownloadTextFile
}
return

MakingFolder:
WinActivate, id.xlsx - Excel
WinWaitActive, id.xlsx - Excel
Send, {Down}
Clipboard =
MyString =
Send ^c
ClipWait 1
MyString := Clipboard
WinActivate Downloads
WinWaitActive, Downloads
Send ^+n
Sleep, 1000
Send ^v
Sleep, 1000
if (StrLen(MyString)>11)
{
     Send, {backspace}
     Sleep, 100
}
Sleep, 1000
Send, ^a
Sleep, 100
return

DownloadItems:
WinActivate PMS INDRA - Internet Explorer
Click 753, 418
Loop, 10 {
    Send {PgUp}
}
Sleep 500
Click 245, 317
Send, {space}
Sleep 200
Loop, %skipItems%
{
    Send, {Tab}
}
Sleep 100
Loop, %unselectItems%
{
    Send, {Space}
    Send, {Tab}
}
Sleep 100
Loop, %selectItems%
{
    Send, {Space}
    Send, {Tab}
}
Sleep 100
Click 257, 130
Click 317, 175
Gosub, Download1
sleep 100
Gosub, FinishDownload2
Gosub, FinishDownload1
return

DownThemAll:
WinActivate PMS INDRA - Internet Explorer
Click 257, 130
Click 314, 239
Click 257, 130
Click 317, 175
Gosub, Download1
sleep 100
Gosub, FinishDownload2
Gosub, FinishDownload1
return

Download1:
WinWaitActive, Download E-File - Internet Explorer

; wait for loading
Loop
{
  PixelSearch, Px, Py, 108, 301, 115, 309, 0x212121, 5, RGB
  if !ErrorLevel
     break
  sleep, 50
}
Click 156, 203

;wait untill the "Execute" button is shown
MouseMove 175, 412
Loop
{
  PixelSearch, Px, Py, 140, 394, 211, 421, 0xA6F4FF, 5, RGB
  if !ErrorLevel
     break
  sleep, 50
}
Click 177, 408

Download2:
WinWaitActive, File Transfer for PMS - Internet Explorer

; wait for loading
Sleep, 1500
Click 408, 67

; wait for "Download" button is shown
Loop
{
  PixelSearch, Px, Py, 208, 156, 269, 170, 0x212121, 5, RGB
  if !ErrorLevel
     break
  sleep, 50
}
Click 245, 163

; wait for "Save" button is shown
Loop
{
  PixelSearch, Px, Py, 317, 608, 325, 614, 0x000000, 5, RGB
  if !ErrorLevel
     break
  sleep, 50
}
; prevent download finish message case
Loop
{
  PixelSearch, Px, Py, 109, 604, 137, 616, 0xFFFFFF, 3, RGB
  if !ErrorLevel
     break
  sleep, 50
}
sleep, 500
Click 320, 610
sleep, 500
Click 330, 662
WinWaitActive, Save As
Sleep 1500
;Click 398, 48
;sleep, 700
;send %DownloadItem%
;sleep, 700
;send {enter}
MouseMove 475, 479
sleep, 700
Click 475, 479
sleep, 700
return

FinishDownload2:
WinActivate, File Transfer for PMS - Internet Explorer
WinWaitActive, File Transfer for PMS - Internet Explorer
MouseMove 449, 15
Loop
{
  PixelSearch, Px, Py, 429, 3, 549, 89, 0xFFFFFF, 5, RGB
  if !ErrorLevel
     break
  sleep, 50
}
Click 449, 15
sleep, 200
return

FinishDownload1:
WinActivate, Download E-File - Internet Explorer
WinWaitActive, Download E-File - Internet Explorer
Sleep 100
Send, {Alt down}
Send, {F4}
Send, {Alt up}
return

FinishDownload0:
WinActivate, PMS INDRA - Internet Explorer
WinWaitActive, PMS INDRA - Internet Explorer
Send, {Alt down}
Send, {space}
Send, {Alt up}
Sleep 50
Send, n
WinActivate, Downloads
WinWaitActive, Downloads
	
return